Bug in Nvidia drivers
=====================

In the Nvidia Driver 470.57.02 on Linux there is a bug in OpenCL's [`mul_hi`], which is only triggered if optimizations are on. If [`-cl-opt-disable` ]is passed into the OpenCL build step, then the expected result is returned.


Usage
-----

This repository reproduces the issue. Simply run `cargo run`. If your driver doesn't have this bug, it prints `result: 254`.

```console
$ cargo run
    Finished dev [unoptimized + debuginfo] target(s) in 0.01s
     Running `target/debug/nvidiabugminimal`
result: 254
```

If you encounter the bug, you will get an error message:

```console
$ cargo run
    Finished dev [unoptimized + debuginfo] target(s) in 0.00s
     Running `target/debug/nvidiabugminimal`
result: 0
thread 'main' panicked at 'assertion failed: `(left == right)`
  left: `0`,
 right: `254`: The result is expected to be 254, but it was 0.', src/main.rs:58:5
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
```


Details
-------

The kernel is really simple:

```opencl
__kernel void call_mul_hi(__global ulong *result) {
    *result = mul_hi((ulong)0xff, (ulong)0xff00000000000001);
}
```

The resulting PTX on a NVIDIA GeForce RTX 2080 Ti is:

```ptx
//
// Generated by NVIDIA NVVM Compiler
//
// Compiler Build ID: CL-30181479
// Unknown Toolkit Version
// Based on LLVM 3.4svn
//

.version 7.4
.target sm_75, texmode_independent
.address_size 64

	// .globl	call_mul_hi

.entry call_mul_hi(
	.param .u64 .ptr .global .align 8 call_mul_hi_param_0
)
{
	.reg .b64 	%rd<5>;


	ld.param.u64 	%rd1, [call_mul_hi_param_0];
	mov.u64 	%rd2, -72057594037927935;
	mov.u64 	%rd3, 255;
	mul.hi.u64 	%rd4, %rd3, %rd2;
	st.global.u64 	[%rd1], %rd4;
	ret;
}
```


License
-------

All code is licensed under the [MIT License].


[`mul_hi`]: https://www.khronos.org/registry/OpenCL/sdk/1.0/docs/man/xhtml/mul_hi.html
[`-cl-opt-disable`]: https://www.khronos.org/registry/OpenCL/sdk/1.0/docs/man/xhtml/clBuildProgram.html#idm122
[MIT License]: LICENSE.
